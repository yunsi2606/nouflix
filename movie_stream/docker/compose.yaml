name: nouflix

services:
  elasticsearch:
    container_name: nouflix.es-container
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.1
    environment:
      - xpack.security.enabled=false
      - "discovery.type=single-node"
    networks:
      - es-net
    ports:
      - 9200:9200
    ulimits:
      nproc: 65535
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:9200 >/dev/null || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    container_name: nouflix.kb-container
    image: docker.elastic.co/kibana/kibana:9.2.1
    environment:
      - ELASTICSEARCH_HOSTS=http://nouflix.es-container:9200
    networks:
      - es-net
    depends_on:
      - elasticsearch
    ports:
      - 5601:5601
  
  nouflix.minio:
    image: minio/minio
    container_name: nouflix.minio
    volumes:
      - minio_data:/data
    ports:
      - "9009:9000"
      - "9091:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: nhatcuong04
    command: server /data --console-address ":9001"
    networks:
      - nouflix-net
    
  nouflix.redis:
    image: redis:latest
    container_name: nouflix.redis
    restart: always
    environment:
      - REDIS_PASSWORD=nhatcuong04
    volumes:
      - redis_volume_data:/data
    ports:
      - 6379:6379
    networks:
      - nouflix-net

  nouflix.redis_insight:
    image: redislabs/redisinsight:latest
    container_name: nouflix.redis_insight
    restart: always
    ports:
      - 8001:5540
    volumes:
      - redis_insight_volume_data:/db
    networks:
      - nouflix-net

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: nouflix.mssql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD}
      - MSSQL_PID=Developer  # Dev miễn phí; production cần license
      - MSSQL_MEMORY_LIMIT_MB=2048
    # Không map port 1433 ra ngoài để an toàn
    volumes:
      - mssql_data:/var/opt/mssql
    healthcheck:
      test: [ "CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "${SA_PASSWORD}", "-C", "-Q", "SELECT 1" ]
      interval: 10s
      timeout: 3s
      retries: 30
    mem_limit: 3g
    mem_reservation: 1g
    cpus: 1.5
    restart: unless-stopped
    networks:
      - nouflix-net
    
  nouflix.api:
    build:
      context: .. # trỏ tới folder chứa .csproj và Dockerfile
      dockerfile: NouFlix/Dockerfile
    container_name: nouflix.api
    environment:
      - ASPNETCORE_URLS=http://+:8083
      - ASPNETCORE_ENVIRONMENT=Development

      - ConnectionStrings__Default=Server=mssql,1433;Database=MoviePortalDB;User Id=sa;Password=${SA_PASSWORD};Encrypt=True;TrustServerCertificate=True
      - ConnectionStrings__Redis=nouflix.redis:6379,password=${REDIS_PASSWORD},ssl=False,abortConnect=False

      - Storage__S3__Endpoint=nouflix.minio:9000
      - Storage__S3__PublicEndpoint=minio-nouflix.nhatcuong.io.vn
      - Storage__S3__AccessKey=${MINIO_ROOT_USER}
      - Storage__S3__SecretKey=${MINIO_ROOT_PASSWORD}
      - Storage__S3__UseSSL=false
        
      - Jwt__Key=${JWT_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      
      - Elasticsearch__Url=http://elasticsearch:9200

      - Auth__External__Google__ClientId=${GOOGLE_CLIENT_ID}
      - Auth__External__Google__ClientSecret=${GOOGLE_CLIENT_SECRET}
      - Auth__External__Facebook__ClientId=${FACEBOOK_CLIENT_ID}
      - Auth__External__Facebook__ClientSecret=${FACEBOOK_CLIENT_SECRET}
      - Auth__Auth__FrontendBaseUrl=${FRONTEND_BASE_URL}
      - Ffmpeg__Path=/usr/bin/ffmpeg

      - Serilog__Using__0=Serilog.Sinks.Console
      - Serilog__Using__1=Serilog.Sinks.Elasticsearch
      - Serilog__MinimumLevel__Default=Warning
      - Serilog__MinimumLevel__Override__Microsoft=Warning
      - Serilog__MinimumLevel__Override__System=Warning
      - Serilog__MinimumLevel__Override__NouFlix=Information
      - Serilog__Enrich__0=FromLogContext
      - Serilog__Enrich__1=WithMachineName
      - Serilog__Enrich__2=WithProcessId
      - Serilog__Enrich__3=WithThreadId
      - Serilog__WriteTo__0__Name=Console
      - Serilog__WriteTo__1__Name=Elasticsearch
      - Serilog__WriteTo__1__Args__nodeUris=http://nouflix.es-container:9200
      - Serilog__WriteTo__1__Args__indexFormat=audit-logs-{0:yyyy.MM.dd}
      - Serilog__WriteTo__1__Args__autoRegisterTemplate=true
      - Serilog__WriteTo__1__Args__autoRegisterTemplateVersion=ESv8
      - Serilog__WriteTo__1__Args__failureCallback=SerilogToElk.SerilogFailureHandler.Handle
      - Serilog__WriteTo__1__Args__emitEventFailure=WriteToSelfLog
      - Serilog__WriteTo__1__Args__bufferBaseFilename=app/LogsLogs/serilog-buffer

      - Stripe__SecretKey=${STRIPE_SECRET_KEY}
      - Momo__PartnerCode=MOMO
      - Momo__Endpoint=https://test-payment.momo.vn/v2/gateway/api/create
      - Momo__AccessKey=${MOMO_ACCESS_KEY}
      - Momo__SecretKey=${MOMO_SECRET_KEY}
      - Momo__StatusEndpoint=https://test-payment.momo.vn/v2/gateway/api/query
      - Momo__ReturnUrl=${FRONTEND_BASE_URL}/payment/callback
      - Momo__NotifyUrl=${BACKEND_BASE_URL}/api/Payment/webhook/momo
    ports:
      - "5003:8083"
    depends_on:
      mssql:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    mem_limit: 3g
    mem_reservation: 1g
    cpus: 2.0
    restart: unless-stopped
    networks:
      - es-net
      - nouflix-net

  nouflix.cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: nouflix.cloudflared
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - ./cloudflared:/etc/cloudflared
    depends_on:
      - nouflix.api
      - nouflix.minio
    mem_limit: 128m
    mem_reservation: 64m
    cpus: 0.25
    restart: unless-stopped
    networks:
      - nouflix-net

volumes:
  minio_data:
  redis_volume_data:
  redis_insight_volume_data:
  mssql_data:
  es_data:

networks:
  es-net:
    driver: bridge
  nouflix-net:
    driver: bridge